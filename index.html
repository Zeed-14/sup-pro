<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir V11 (Pemindai Cepat)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Pustaka untuk Barcode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {--background: #f0f2f5;--card-bg: #ffffff;--text-primary: #1f2937;--text-secondary: #6b7280;--primary-color: #4f46e5;--primary-hover: #4338ca;--border-color: #e5e7eb;}
        body {font-family: 'Inter', sans-serif;background-color: var(--background);color: var(--text-primary);}
        .scrollbar-thin::-webkit-scrollbar { width: 5px; } .scrollbar-thin::-webkit-scrollbar-track { background: #e5e7eb; } .scrollbar-thin::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 5px; }
        .tab-btn {position: relative;transition: color 0.3s ease;}
        .tab-btn.active {color: var(--primary-color);font-weight: 600;}
        .tab-btn.active::after {content: '';position: absolute;bottom: -1px;left: 0;right: 0;height: 3px;background-color: var(--primary-color);border-radius: 2px;}
        .card {background-color: var(--card-bg);border-radius: 12px;box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);}
        .btn-primary {background-color: var(--primary-color);color: white;transition: background-color 0.3s ease;}
        .btn-primary:hover {background-color: var(--primary-hover);}
        .modal-box {transition: all 0.3s ease-out;border-radius: 12px;}
        #search-dropdown {max-height: 200px; overflow-y: auto;}
        #reader-container { border: 4px solid var(--primary-color); border-radius: 12px; transition: border-color 0.1s ease-out; position: relative; }
        #scanner-modal #reader { border-radius: 8px; overflow: hidden; }
        .viewfinder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 40%; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); border: 2px dashed #fff; }
        .status-pill { transition: all 0.3s ease; }
        .opname-input { width: 80px; text-align: center; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; }
        .opname-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .selisih-plus { color: #16a34a; font-weight: bold; }
        .selisih-minus { color: #dc2626; font-weight: bold; }
        .sub-tab-btn.active { border-color: var(--primary-color); color: var(--primary-color); background-color: #eef2ff; }
        @media print {
            body.printing .no-print { display: none; }
            body.printing #printable-area { display: block; }
            body.printing > *:not(#printable-area) { display: none; }
            #printable-area { position: absolute; top: 0; left: 0; width: 100%;}
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 lg:p-6 no-print">
        <!-- HEADER -->
        <header class="mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img id="header-logo" src="https://placehold.co/60x60/e0e7ff/4338ca?text=Logo" alt="Logo Toko" class="h-12 w-12 rounded-full object-cover shadow-md">
                <h1 id="main-app-title" class="text-2xl md:text-3xl font-extrabold text-gray-800">Aplikasi Kasir</h1>
            </div>
            <div id="sync-status" class="status-pill text-xs font-semibold text-gray-700 bg-gray-200 px-3 py-1 rounded-full shadow-sm flex items-center gap-2">
                <i id="sync-icon" class="fas fa-spinner fa-spin"></i>
                <span id="sync-text">Menghubungkan...</span>
            </div>
        </header>
        
        <!-- NAV TABS -->
        <div class="mb-6 border-b border-gray-200"><nav class="flex space-x-2 md:space-x-6"><button id="tab-kasir" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500 active"><i class="fas fa-cash-register mr-2 opacity-70"></i>Kasir</button><button id="tab-manajemen" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-box-open mr-2 opacity-70"></i>Produk</button><button id="tab-laporan" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-chart-line mr-2 opacity-70"></i>Laporan</button><button id="tab-pengaturan" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-cog mr-2 opacity-70"></i>Pengaturan</button></nav></div>
        
        <main>
            <!-- VIEW KASIR -->
            <div id="view-kasir"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Search and Add Product -->
                <div class="lg:col-span-2 card p-4">
                    <h2 class="text-xl font-bold mb-4">Tambah Produk ke Keranjang</h2>
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <input type="text" id="search-product-input" placeholder="Ketik untuk mencari produk..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 transition">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <div id="search-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden scrollbar-thin"></div>
                        </div>
                        <button id="scan-barcode-kasir-btn" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" title="Pindai Barcode untuk Menambah ke Keranjang"><i class="fas fa-barcode text-xl"></i></button>
                    </div>
                </div>
                <!-- Cart -->
                <div class="lg:col-span-1"><div class="card p-4 sticky top-6"><h2 class="text-xl font-bold mb-4 border-b pb-3">Keranjang</h2><div id="cart-items" class="h-72 overflow-y-auto scrollbar-thin mb-4 pr-2"><p id="cart-placeholder" class="text-gray-400 text-center mt-12">Keranjang Anda kosong.</p></div><div class="space-y-3 border-t pt-4"><div class="flex justify-between items-center font-semibold"><span>Total</span><span id="total-price" class="text-2xl font-bold text-indigo-600">Rp 0</span></div><div class="flex justify-between items-center"><span>Bayar</span><input type="number" id="payment-amount" placeholder="Jumlah uang" class="w-36 text-right p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"></div><div class="flex justify-between items-center font-semibold"><span>Kembali</span><span id="change-amount" class="text-xl text-green-600 font-bold">Rp 0</span></div></div><div class="mt-6 grid grid-cols-2 gap-3"><button id="reset-button" class="w-full bg-red-100 text-red-700 font-bold py-3 rounded-lg hover:bg-red-200 transition flex items-center justify-center gap-2"><i class="fas fa-sync-alt"></i> Reset</button><button id="process-payment-button" class="w-full btn-primary font-bold py-3 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-cash-register"></i> Bayar</button></div></div></div>
            </div></div>

            <!-- VIEW MANAJEMEN PRODUK -->
            <div id="view-manajemen" class="hidden"><div class="card p-6"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4"><h2 class="text-xl font-bold">Daftar Semua Produk</h2><div id="manajemen-actions" class="flex items-center gap-4"><button id="start-opname-btn" class="bg-yellow-100 text-yellow-800 font-bold px-4 py-2 rounded-lg hover:bg-yellow-200 flex items-center gap-2 transition"><i class="fas fa-clipboard-check"></i> Mulai Stok Opname</button><button id="scan-to-add-btn" class="bg-indigo-100 text-indigo-700 font-bold px-4 py-2 rounded-lg hover:bg-indigo-200 flex items-center gap-2 transition"><i class="fas fa-barcode-read"></i> Pindai</button><button id="add-product-btn" class="bg-green-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2 transition"><i class="fas fa-plus"></i> Tambah Produk</button></div><div id="opname-actions" class="hidden items-center gap-4"><button id="cancel-opname-btn" class="bg-gray-200 text-gray-800 font-bold px-4 py-2 rounded-lg hover:bg-gray-300 flex items-center gap-2 transition"><i class="fas fa-times"></i> Batal</button><button id="finish-opname-btn" class="bg-blue-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 transition"><i class="fas fa-save"></i> Selesaikan & Sesuaikan Stok</button></div></div><div id="all-products-table-container" class="overflow-x-auto"></div></div></div>

            <!-- VIEW LAPORAN -->
            <div id="view-laporan" class="hidden">
                <div class="mb-6 border-b border-gray-200"><nav class="flex space-x-1" aria-label="Tabs"><button id="report-tab-ringkasan" class="sub-tab-btn active font-semibold px-4 py-2 rounded-t-lg border-b-2">Ringkasan Penjualan</button><button id="report-tab-analisis" class="sub-tab-btn font-semibold px-4 py-2 rounded-t-lg border-b-2">Analisis Keuangan</button></nav></div>
                <div id="report-content-ringkasan"><div class="card p-6"><div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-gray-50 rounded-lg"><select id="date-filter" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"><option value="today">Hari Ini</option><option value="last7days">7 Hari Terakhir</option><option value="thismonth">Bulan Ini</option><option value="custom">Kustom</option></select><div id="custom-date-range" class="flex gap-2 items-center hidden"><input type="date" id="start-date" class="p-2 border border-gray-300 rounded-lg"><span class="text-gray-500">hingga</span><input type="date" id="end-date" class="p-2 border border-gray-300 rounded-lg"><button id="apply-custom-date" class="px-4 py-2 btn-primary rounded-lg"><i class="fas fa-check"></i></button></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-lg"><p class="text-sm text-indigo-700 font-medium">Total Omzet</p><p id="report-omzet" class="text-3xl font-extrabold text-indigo-900">Rp 0</p></div>
                    <div class="bg-green-50 p-6 rounded-lg"><p class="text-sm text-green-700 font-medium">Total Transaksi</p><p id="report-transaksi" class="text-3xl font-extrabold text-green-900">0</p></div>
                    <div id="low-stock-report-btn" class="bg-red-50 p-6 rounded-lg cursor-pointer hover:shadow-lg transition"><p class="text-sm text-red-700 font-medium">Stok Kritis</p><p id="report-low-stock-count" class="text-3xl font-extrabold text-red-900">0</p></div>
                    <div id="bestseller-report-btn" class="bg-purple-50 p-6 rounded-lg cursor-pointer hover:shadow-lg transition"><p class="text-sm text-purple-700 font-medium">Produk Terlaris</p><p class="text-xl font-bold text-purple-900 truncate">Lihat Detail</p></div>
                </div><h3 class="text-xl font-bold mb-4">Rincian Transaksi</h3><div id="report-transactions-table" class="overflow-x-auto"></div></div></div>
                <div id="report-content-analisis" class="hidden"><div class="card p-6"><h2 class="text-2xl font-bold mb-4">Analisis Keuangan</h2><p class="text-sm text-gray-500 mb-6">Metrik di bawah ini dihitung berdasarkan rentang tanggal yang dipilih di tab Ringkasan.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-green-50 p-6 rounded-lg"><p class="text-sm text-green-700 font-medium">Estimasi Total Laba</p><p id="analysis-profit" class="text-3xl font-extrabold text-green-900">Rp 0</p><p class="text-xs text-gray-500 mt-1">Laba = (Harga Jual - Harga Setor) untuk barang titipan, dan Harga Jual penuh untuk barang milik sendiri.</p></div>
                    <div class="bg-orange-50 p-6 rounded-lg"><p class="text-sm text-orange-700 font-medium">Total Hutang ke Pemasok</p><p id="analysis-debt" class="text-3xl font-extrabold text-orange-900">Rp 0</p><p class="text-xs text-gray-500 mt-1">Total harga setor dari semua barang titipan yang telah terjual pada periode ini.</p></div>
                </div></div></div>
            </div>

            <!-- VIEW PENGATURAN -->
            <div id="view-pengaturan" class="hidden">
                 <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-1" aria-label="Tabs">
                      <button id="settings-tab-profil" class="sub-tab-btn active font-semibold px-4 py-2 rounded-t-lg border-b-2">Profil Toko</button>
                      <button id="settings-tab-kategori" class="sub-tab-btn font-semibold px-4 py-2 rounded-t-lg border-b-2">Kategori</button>
                      <button id="settings-tab-data" class="sub-tab-btn font-semibold px-4 py-2 rounded-t-lg border-b-2">Data</button>
                    </nav>
                 </div>
                 <div id="settings-content-profil" class="card p-8">
                    <h2 class="text-2xl font-bold mb-6">Pengaturan Profil Toko</h2>
                    <form id="settings-form" class="space-y-6">
                        <div><label for="store-logo-upload" class="block text-sm font-medium text-gray-700 mb-1">Logo Toko</label><input type="file" id="store-logo-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                        <div><label for="store-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Toko</label><input type="text" id="store-name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></div>
                        <div><label for="store-address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Toko</label><textarea id="store-address" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea></div>
                        <div><label for="store-phone" class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label><input type="tel" id="store-phone" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></div>
                        <div class="flex justify-end pt-4"><button type="submit" class="px-8 py-3 btn-primary font-bold rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Simpan</button></div>
                    </form>
                 </div>
                 <div id="settings-content-kategori" class="card p-8 hidden">
                    <h2 class="text-2xl font-bold mb-6">Manajemen Kategori</h2>
                    <div class="mb-6"><form id="add-category-form" class="flex gap-2"><input type="text" id="new-category-name" placeholder="Nama kategori baru" class="flex-grow p-3 border border-gray-300 rounded-lg" required><button type="submit" class="bg-green-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-green-600">Tambah</button></form></div>
                    <div id="category-table-container" class="overflow-x-auto"></div>
                 </div>
                 <div id="settings-content-data" class="card p-8 hidden">
                    <h2 class="text-2xl font-bold mb-6">Manajemen Data (Lokal)</h2>
                    <p class="text-sm text-gray-600 mb-4">Buat cadangan data ke file lokal sebagai keamanan tambahan, atau pulihkan data dari file tersebut. Tindakan ini hanya mempengaruhi data di perangkat ini jika terjadi kesalahan.</p><div class="flex gap-4"><button id="backup-data-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2 transition"><i class="fas fa-download"></i> Backup</button><button id="restore-data-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 transition"><i class="fas fa-upload"></i> Restore</button><input type="file" id="restore-file-input" class="hidden" accept=".json"></div>
                 </div>
            </div>
        </main>
    </div>
    
    <!-- WRAPPER FOR PRINTABLE AREA -->
    <div id="printable-area" class="hidden"></div>

    <!-- ALL MODALS -->
    <div id="scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center hidden z-50 modal-container no-print">
        <div class="w-full max-w-md p-4 bg-white rounded-lg shadow-xl">
            <p id="scanner-status" class="text-center font-semibold mb-2"></p>
            <div id="reader-container">
                 <div id="reader" class="w-full"></div>
                 <div class="viewfinder"></div>
            </div>
            <button id="close-scanner-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition">Tutup Pemindai</button>
        </div>
    </div>
    <div id="product-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-40 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-lg"><h3 id="modal-title" class="text-2xl font-bold mb-6"></h3><form id="product-form"><input type="hidden" id="product-id"><div class="mb-4"><label for="product-name" class="block mb-2">Nama Produk</label><input type="text" id="product-name" class="w-full p-3 border rounded-lg" required></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="product-type" class="block mb-2">Jenis Produk</label><select id="product-type" class="w-full p-3 border rounded-lg"><option value="owned">Milik Sendiri</option><option value="consignment">Barang Titipan</option></select></div><div id="harga-setor-container" class="hidden"><label for="product-harga-setor" class="block mb-2">Harga Setor (Beli)</label><input type="number" id="product-harga-setor" class="w-full p-3 border rounded-lg"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="product-category" class="block mb-2">Kategori</label><select id="product-category" class="w-full p-3 border rounded-lg"></select></div><div><label for="product-barcode" class="block mb-2">Barcode</label><input type="text" id="product-barcode" class="w-full p-3 border rounded-lg"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="product-price" class="block mb-2">Harga Jual</label><input type="number" id="product-price" class="w-full p-3 border rounded-lg" required></div><div><label for="product-stock" class="block mb-2">Stok</label><input type="number" id="product-stock" class="w-full p-3 border rounded-lg" required></div></div><div class="mb-6"><label for="product-image-upload" class="block mb-2">Gambar Produk</label><input type="file" id="product-image-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200"><input type="hidden" id="product-image-base64"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" id="save-btn" class="px-6 py-2 btn-primary font-semibold rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Simpan</button></div></form></div></div>
    <div id="restock-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-sm"><h3 class="text-2xl font-bold mb-6">Restok Produk</h3><form id="restock-form"><input type="hidden" id="restock-product-id"><div class="mb-4"><p>Produk: <span id="restock-product-name" class="font-bold"></span></p><p>Stok Saat Ini: <span id="restock-current-stock"></span></p></div><div class="mb-6"><label for="restock-quantity" class="block mb-2">Jumlah Stok Tambahan</label><input type="number" id="restock-quantity" class="w-full p-3 border rounded-lg" required min="1"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-restock-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg">Tambah Stok</button></div></form></div></div>
    <div id="return-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-sm"><h3 class="text-2xl font-bold mb-6">Retur ke Pemasok</h3><form id="return-form"><input type="hidden" id="return-product-id"><div class="mb-4"><p>Produk: <span id="return-product-name" class="font-bold"></span></p><p>Stok Saat Ini: <span id="return-current-stock"></span></p></div><div class="mb-6"><label for="return-quantity" class="block mb-2">Jumlah Diretur</label><input type="number" id="return-quantity" class="w-full p-3 border rounded-lg" required min="1"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-return-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" class="px-6 py-2 bg-orange-500 text-white font-semibold rounded-lg">Proses Retur</button></div></form></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box text-center w-full max-w-sm"><div id="confirm-icon" class="mb-4"><i class="fas fa-exclamation-triangle fa-4x text-red-500"></i></div><h3 id="confirm-title" class="text-xl font-bold">Anda Yakin?</h3><p id="confirm-message" class="text-gray-600 mt-2 mb-6">Aksi ini tidak dapat dibatalkan.</p><div class="flex justify-center gap-4"><button id="cancel-confirm-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg">Ya, Lanjutkan</button></div></div></div>
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 no-print"><div class="bg-white p-8 modal-box text-center"><div id="modal-icon"></div><h3 id="notification-title" class="text-2xl font-bold mt-4"></h3><p id="notification-message" class="text-gray-600 mt-2"></p><button id="modal-close-button" class="mt-6 btn-primary font-semibold px-6 py-2 rounded-lg">Tutup</button></div></div>
    <div id="struk-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg w-full max-w-sm font-mono text-xs shadow-2xl"><div class="text-center mb-4"><img id="struk-logo" src="" alt="Logo" class="h-16 w-16 mx-auto mb-2 rounded-full object-cover"><h3 id="struk-store-name" class="text-base font-bold uppercase">Nama Toko Anda</h3><p id="struk-store-address">Alamat Toko Anda</p><p id="struk-store-phone">Telp: 08123456789</p><hr class="border-dashed my-2"></div><div id="struk-info" class="mb-2"></div><hr class="border-dashed my-2"><div id="struk-items" class="py-1"></div><hr class="border-dashed my-2"><div id="struk-total" class="space-y-1 pt-2"></div><hr class="border-dashed my-2"><div class="text-center mt-4"><p>Terima kasih telah berbelanja!</p></div><div class="mt-6 flex justify-end gap-3 no-print"><button id="struk-close-btn" class="px-4 py-2 bg-gray-200 font-semibold rounded-lg">Tutup</button><button id="struk-print-btn" class="px-4 py-2 btn-primary font-semibold rounded-lg flex items-center gap-2"><i class="fas fa-print"></i> Cetak</button></div></div></div>
    <div id="report-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 no-print"><div class="bg-white p-6 modal-box w-full max-w-2xl"><h3 id="report-details-title" class="text-2xl font-bold mb-4"></h3><div id="report-details-content" class="overflow-y-auto" style="max-height: 70vh;"></div><div class="mt-6 text-right"><button id="report-details-close-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Tutup</button></div></div></div>

    <script>
        // --- GLOBAL STATE, CONFIG & DOM REFS ---
        const supabaseConfig = {
            supabaseUrl: 'https://ftpzzlmfrdbrzpjntdwx.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0cHp6bG1mcmRicnpwam50ZHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzQwMDYsImV4cCI6MjA2NjUxMDAwNn0.ctuq8u38hFTbFr7hj0tP0SfSyUBlB2iU2A1MX2nwAuI'
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';
        let productsData = [], transactionsData = [], categoriesData = [], cart = [], storeSettings = {
            name: "Aplikasi Kasir",
            address: "Alamat Toko",
            phone: "No. Telepon", 
            logo: "https://placehold.co/60x60/e0e7ff/4338ca?text=Logo"
        };
        
        let currentActionConfirm = null, html5QrCode, scannerMode = null, isOpnameMode = false, isProcessingScan = false;
        let supabase, userId, isAuthReady = false;
        let productsSubscription, transactionsSubscription, categoriesSubscription, settingsSubscription;
        const LOW_STOCK_THRESHOLD = 10;
        
        const dom = {
            headerLogo: document.getElementById("header-logo"),
            mainTitle: document.getElementById("main-app-title"),
            kasirView: document.getElementById("view-kasir"),
            manajemenView: document.getElementById("view-manajemen"),
            laporanView: document.getElementById("view-laporan"),
            pengaturanView: document.getElementById("view-pengaturan"),
            kasirTab: document.getElementById("tab-kasir"),
            manajemenTab: document.getElementById("tab-manajemen"),
            laporanTab: document.getElementById("tab-laporan"),
            pengaturanTab: document.getElementById("tab-pengaturan"),
            cartItems: document.getElementById("cart-items"),
            cartPlaceholder: document.getElementById("cart-placeholder"),
            totalPrice: document.getElementById("total-price"),
            paymentAmount: document.getElementById("payment-amount"),
            changeAmount: document.getElementById("change-amount"),
            resetButton: document.getElementById("reset-button"),
            paymentButton: document.getElementById("process-payment-button"),
            allProductsTable: document.getElementById("all-products-table-container"),
            addProductButton: document.getElementById("add-product-btn"),
            productModal: document.getElementById("product-form-modal"),
            productForm: document.getElementById("product-form"),
            productModalTitle: document.getElementById("modal-title"),
            productIdInput: document.getElementById("product-id"),
            productNameInput: document.getElementById("product-name"),
            productPriceInput: document.getElementById("product-price"),
            productImageUpload: document.getElementById("product-image-upload"),
            productImageBase64: document.getElementById("product-image-base64"),
            productStockInput: document.getElementById("product-stock"),
            productCategorySelect: document.getElementById("product-category"),
            productBarcodeInput: document.getElementById("product-barcode"),
            cancelButton: document.getElementById("cancel-btn"),
            saveButton: document.getElementById("save-btn"),
            confirmModal: document.getElementById("confirm-modal"),
            cancelConfirmButton: document.getElementById("cancel-confirm-btn"),
            confirmActionButton: document.getElementById("confirm-action-btn"),
            confirmTitle: document.getElementById("confirm-title"),
            confirmMessage: document.getElementById("confirm-message"),
            notificationModal: document.getElementById("notification-modal"),
            notificationTitle: document.getElementById("notification-title"),
            notificationMessage: document.getElementById("notification-message"),
            notificationIcon: document.getElementById("modal-icon"),
            notificationCloseButton: document.getElementById("modal-close-button"),
            searchInput: document.getElementById("search-product-input"),
            searchDropdown: document.getElementById("search-dropdown"),
            strukModal: document.getElementById("struk-modal"),
            strukLogo: document.getElementById("struk-logo"),
            strukStoreName: document.getElementById("struk-store-name"),
            strukStoreAddress: document.getElementById("struk-store-address"),
            strukStorePhone: document.getElementById("struk-store-phone"),
            strukInfo: document.getElementById("struk-info"),
            strukItems: document.getElementById("struk-items"),
            strukTotal: document.getElementById("struk-total"),
            strukCloseButton: document.getElementById("struk-close-btn"),
            strukPrintButton: document.getElementById("struk-print-btn"),
            dateFilter: document.getElementById("date-filter"),
            customDateRange: document.getElementById("custom-date-range"),
            startDate: document.getElementById("start-date"),
            endDate: document.getElementById("end-date"),
            applyDateButton: document.getElementById("apply-custom-date"),
            reportOmzet: document.getElementById("report-omzet"),
            reportTransaksi: document.getElementById("report-transaksi"),
            reportLowStockCount: document.getElementById("report-low-stock-count"),
            lowStockReportBtn: document.getElementById("low-stock-report-btn"),
            bestsellerReportBtn: document.getElementById("bestseller-report-btn"),
            reportTerlarisSummary: document.getElementById("report-terlaris-summary"),
            reportTable: document.getElementById("report-transactions-table"),
            reportDetailsModal: document.getElementById("report-details-modal"),
            reportDetailsTitle: document.getElementById("report-details-title"),
            reportDetailsContent: document.getElementById("report-details-content"),
            reportDetailsCloseBtn: document.getElementById("report-details-close-btn"),
            restockModal: document.getElementById("restock-modal"),
            restockForm: document.getElementById("restock-form"),
            restockProductId: document.getElementById("restock-product-id"),
            restockProductName: document.getElementById("restock-product-name"),
            restockCurrentStock: document.getElementById("restock-current-stock"),
            restockQuantity: document.getElementById("restock-quantity"),
            cancelRestockButton: document.getElementById("cancel-restock-btn"),
            settingsForm: document.getElementById("settings-form"),
            storeLogoUpload: document.getElementById("store-logo-upload"),
            storeNameInput: document.getElementById("store-name"),
            storeAddressInput: document.getElementById("store-address"),
            storePhoneInput: document.getElementById("store-phone"),
            backupBtn: document.getElementById("backup-data-btn"),
            restoreBtn: document.getElementById("restore-data-btn"),
            restoreFileInput: document.getElementById("restore-file-input"),
            printableArea: document.getElementById("printable-area"),
            scanBarcodeKasirBtn: document.getElementById("scan-barcode-kasir-btn"),
            scanToAddBtn: document.getElementById("scan-to-add-btn"),
            scannerModal: document.getElementById("scanner-modal"),
            scannerStatus: document.getElementById('scanner-status'),
            readerContainer: document.getElementById('reader-container'),
            closeScannerBtn: document.getElementById("close-scanner-btn"),
            syncStatus: document.getElementById('sync-status'),
            syncIcon: document.getElementById('sync-icon'),
            syncText: document.getElementById('sync-text'),
            manajemenActions: document.getElementById('manajemen-actions'),
            opnameActions: document.getElementById('opname-actions'),
            startOpnameBtn: document.getElementById('start-opname-btn'),
            cancelOpnameBtn: document.getElementById('cancel-opname-btn'),
            finishOpnameBtn: document.getElementById('finish-opname-btn'),
            settingsTabProfil: document.getElementById('settings-tab-profil'),
            settingsTabKategori: document.getElementById('settings-tab-kategori'),
            settingsTabData: document.getElementById('settings-tab-data'),
            settingsContentProfil: document.getElementById('settings-content-profil'),
            settingsContentKategori: document.getElementById('settings-content-kategori'),
            settingsContentData: document.getElementById('settings-content-data'),
            addCategoryForm: document.getElementById('add-category-form'),
            newCategoryNameInput: document.getElementById('new-category-name'),
            categoryTableContainer: document.getElementById('category-table-container'),
            productTypeSelect: document.getElementById('product-type'),
            hargaSetorContainer: document.getElementById('harga-setor-container'),
            hargaSetorInput: document.getElementById('product-harga-setor'),
            returnModal: document.getElementById('return-modal'),
            returnForm: document.getElementById('return-form'),
            returnProductId: document.getElementById('return-product-id'),
            returnProductName: document.getElementById('return-product-name'),
            returnCurrentStock: document.getElementById('return-current-stock'),
            returnQuantity: document.getElementById('return-quantity'),
            cancelReturnBtn: document.getElementById('cancel-return-btn'),
            reportTabRingkasan: document.getElementById('report-tab-ringkasan'),
            reportTabAnalisis: document.getElementById('report-tab-analisis'),
            reportContentRingkasan: document.getElementById('report-content-ringkasan'),
            reportContentAnalisis: document.getElementById('report-content-analisis'),
            analysisProfit: document.getElementById('analysis-profit'),
            analysisDebt: document.getElementById('analysis-debt')
        };

        // --- UTILS & HELPERS ---
        const formatRupiah = (n) => new Intl.NumberFormat("id-ID", {style: "currency", currency: "IDR", minimumFractionDigits: 0}).format(n);
        const formatDate = (d) => new Date(d).toLocaleString("id-ID", {dateStyle: "long", timeStyle: "short"});
        
        const showNotif = (type, title, message) => {
            const icons = {
                success: '<i class="fas fa-check-circle text-5xl text-green-500"></i>',
                error: '<i class="fas fa-times-circle text-5xl text-red-500"></i>',
                info: '<i class="fas fa-info-circle text-5xl text-blue-500"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>'
            };
            dom.notificationIcon.innerHTML = icons[type] || "";
            dom.notificationTitle.textContent = title;
            dom.notificationMessage.textContent = message;
            dom.notificationModal.classList.remove("hidden");
            dom.notificationModal.classList.add("flex");
        };
        
        const hideNotif = () => {
            dom.notificationModal.classList.add("hidden");
            dom.notificationModal.classList.remove("flex");
        };
        
        const showConfirm = (title, message, onConfirm) => {
            dom.confirmTitle.textContent = title;
            dom.confirmMessage.textContent = message;
            currentActionConfirm = onConfirm;
            dom.confirmModal.classList.remove("hidden");
            dom.confirmModal.classList.add("flex");
        };
        
        const hideConfirm = () => {
            dom.confirmModal.classList.add("hidden");
            dom.confirmModal.classList.remove("flex");
            currentActionConfirm = null;
        };
        
        const updateSettingsUI = (settings) => {
            dom.headerLogo.src = settings.logo;
            dom.mainTitle.textContent = settings.name;
            dom.strukLogo.src = settings.logo;
            dom.strukStoreName.textContent = settings.name;
            dom.strukStoreAddress.textContent = settings.address;
            dom.strukStorePhone.textContent = settings.phone;
            dom.storeNameInput.value = settings.name;
            dom.storeAddressInput.value = settings.address;
            dom.storePhoneInput.value = settings.phone;
        };
        
        const switchView = (v) => {
            const views = ["kasir", "manajemen", "laporan", "pengaturan"];
            views.forEach(view => {
                dom[`${view}View`].classList.toggle("hidden", v !== view);
                dom[`${view}Tab`].classList.toggle("active", v === view);
            });
            if (v === 'laporan') runAllReports();
        };
        
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
        
        const setSyncStatus = (status, message) => {
            const statusClasses = {
                syncing: { text: "Menyinkronkan...", icon: "fa-spinner fa-spin", bg: "bg-yellow-200", text_color: "text-yellow-800" },
                synced: { text: "Tersinkron", icon: "fa-check-circle", bg: "bg-green-100", text_color: "text-green-800" },
                offline: { text: "Offline", icon: "fa-cloud-slash", bg: "bg-gray-200", text_color: "text-gray-800" }
            };
            const s = statusClasses[status] || statusClasses.offline;
            dom.syncText.textContent = message || s.text;
            dom.syncIcon.className = `fas ${s.icon}`;
            dom.syncStatus.className = `status-pill text-xs font-semibold px-3 py-1 rounded-full shadow-sm flex items-center gap-2 ${s.bg} ${s.text_color}`;
        };

        // --- SUPABASE SETUP & REAL-TIME LISTENERS ---
        const setupSupabaseListeners = async (uid) => {
            if (!uid) return;
            
            userId = uid;
            
            // Unsubscribe existing listeners if any
            if (productsSubscription) supabase.removeChannel(productsSubscription);
            if (transactionsSubscription) supabase.removeChannel(transactionsSubscription);
            if (categoriesSubscription) supabase.removeChannel(categoriesSubscription);
            if (settingsSubscription) supabase.removeChannel(settingsSubscription);
            
            // Fetch initial data and setup subscriptions
            try {
                // Products
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('user_id', userId)
                    .order('name', { ascending: true });
                
                if (productsError) throw productsError;
                
                productsData = products;
                
                // Setup real-time subscription for products
                productsSubscription = supabase
                    .channel('products_changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'products',
                        filter: `user_id=eq.${userId}`
                    }, (payload) => {
                        setSyncStatus('synced');
                        if (payload.eventType === 'INSERT') {
                            productsData.push(payload.new);
                        } else if (payload.eventType === 'UPDATE') {
                            const index = productsData.findIndex(p => p.id === payload.new.id);
                            if (index !== -1) productsData[index] = payload.new;
                        } else if (payload.eventType === 'DELETE') {
                            productsData = productsData.filter(p => p.id !== payload.old.id);
                        }
                        productsData.sort((a, b) => a.name.localeCompare(b.name));
                        refreshUI();
                    })
                    .subscribe();
                
                // Transactions
                const { data: transactions, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (transactionsError) throw transactionsError;
                
                transactionsData = transactions;
                
                // Setup real-time subscription for transactions
                transactionsSubscription = supabase
                    .channel('transactions_changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'transactions',
                        filter: `user_id=eq.${userId}`
                    }, (payload) => {
                        if (payload.eventType === 'INSERT') {
                            transactionsData.unshift(payload.new);
                        } else if (payload.eventType === 'DELETE') {
                            transactionsData = transactionsData.filter(t => t.id !== payload.old.id);
                        }
                        refreshUI();
                    })
                    .subscribe();
                
                // Categories
                const { data: categories, error: categoriesError } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', userId)
                    .order('name', { ascending: true });
                
                if (categoriesError) throw categoriesError;
                
                categoriesData = categories;
                
                // Setup real-time subscription for categories
                categoriesSubscription = supabase
                    .channel('categories_changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'categories',
                        filter: `user_id=eq.${userId}`
                    }, (payload) => {
                        if (payload.eventType === 'INSERT') {
                            categoriesData.push(payload.new);
                        } else if (payload.eventType === 'UPDATE') {
                            const index = categoriesData.findIndex(c => c.id === payload.new.id);
                            if (index !== -1) categoriesData[index] = payload.new;
                        } else if (payload.eventType === 'DELETE') {
                            categoriesData = categoriesData.filter(c => c.id !== payload.old.id);
                        }
                        categoriesData.sort((a, b) => a.name.localeCompare(b.name));
                        populateCategorySelect();
                        renderCategoryManagementTable();
                    })
                    .subscribe();
                
                // Settings
                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (!settingsError && settings) {
                    storeSettings = settings;
                    updateSettingsUI(storeSettings);
                }
                
                // Setup real-time subscription for settings
                settingsSubscription = supabase
                    .channel('settings_changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'settings',
                        filter: `user_id=eq.${userId}`
                    }, (payload) => {
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            storeSettings = payload.new;
                            updateSettingsUI(storeSettings);
                        }
                    })
                    .subscribe();
                
                setSyncStatus('synced');
                isAuthReady = true;
                refreshUI();
                
            } catch (error) {
                console.error("Error setting up listeners:", error);
                setSyncStatus('offline', 'Error');
                showNotif('error', 'Koneksi Error', 'Gagal memuat data dari server.');
            }
        };

        // --- BARCODE SCANNER LOGIC (ROBUST) ---
        const startScanner = (mode) => {
            scannerMode = mode;
            dom.scannerModal.classList.remove('hidden');
            dom.scannerModal.classList.add('flex');
            dom.scannerStatus.textContent = "Meminta izin kamera...";
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    dom.scannerStatus.textContent = "Arahkan kamera ke barcode";
                    
                    html5QrCode.start(
                        cameraId, 
                        { 
                            fps: 20, 
                            qrbox: { width: 280, height: 120 },
                            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
                        },
                        onScanSuccess,
                        (errorMessage) => { /* ignore parse error */ }
                    ).catch((err) => {
                        console.error(`Unable to start scanning, error: ${err}`);
                        dom.scannerStatus.textContent = "Gagal memulai kamera.";
                        showNotif('error', 'Scan Gagal', `Tidak dapat memulai kamera. Error: ${err}`);
                    });
                } else {
                    showNotif('error', 'Kamera Error', 'Tidak ada kamera yang ditemukan di perangkat ini.');
                    stopScanner();
                }
            }).catch(err => {
                console.error(err);
                dom.scannerStatus.textContent = "Izin kamera ditolak.";
                showNotif('error', 'Izin Ditolak', 'Aplikasi memerlukan izin untuk menggunakan kamera.');
                stopScanner();
            });
        };
        
        const onScanSuccess = async (decodedText, decodedResult) => {
            if (isProcessingScan) return;
            isProcessingScan = true;
            
            if (navigator.vibrate) navigator.vibrate(150);
            if (dom.readerContainer) dom.readerContainer.style.borderColor = '#22c55e';
            
            await stopScanner(true); // Stop scanner but keep modal open for feedback
            
            const trimmedCode = decodedText.trim();
            if (!trimmedCode) {
                isProcessingScan = false;
                showNotif('error', 'Scan Gagal', 'Kode barcode kosong atau tidak valid.');
                return;
            }
            
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('barcode', trimmedCode);
                
                if (error) throw error;
                
                if (scannerMode === 'addToCart') {
                    if (products && products.length > 0) {
                        const product = products[0];
                        addToCart(product.id);
                        showNotif("success", "Produk Ditemukan", `${product.name} ditambahkan.`);
                    } else {
                        showNotif("error", "Tidak Ditemukan", `Produk dengan barcode [${trimmedCode}] tidak ada.`);
                    }
                } else if (scannerMode === 'findOrAddProduct') {
                    if (products && products.length > 0) {
                        const product = products[0];
                        showProductModal(true, product);
                        showNotif("success", "Produk Ditemukan", `Menampilkan data untuk ${product.name}.`);
                    } else {
                        showProductModal(false);
                        dom.productBarcodeInput.value = trimmedCode;
                        showNotif("info", "Produk Baru", `Barcode [${trimmedCode}] tidak ditemukan.`);
                    }
                }
            } catch (error) {
                console.error("Error processing barcode:", error);
                showNotif("error", "Error", "Terjadi kesalahan saat memproses barcode.");
            }
            
            setTimeout(() => {
                dom.scannerModal.classList.add('hidden');
                dom.scannerModal.classList.remove('flex');
                isProcessingScan = false;
            }, 1000); // Close modal after feedback
        };
        
        const stopScanner = async (keepModalOpen = false) => {
            if (html5QrCode && html5QrCode.isScanning) {
                try {
                    await html5QrCode.stop();
                } catch (err) {
                    console.error("Gagal menghentikan scanner.", err);
                }
            }
            
            if (!keepModalOpen) {
                dom.scannerModal.classList.add('hidden');
                dom.scannerModal.classList.remove('flex');
            }
            
            if (dom.readerContainer) dom.readerContainer.style.borderColor = 'var(--primary-color)';
            isProcessingScan = false;
        };

        // --- CATEGORY MANAGEMENT ---
        const populateCategorySelect = () => {
            const currentVal = dom.productCategorySelect.value;
            dom.productCategorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
            
            categoriesData.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const option = document.createElement("option");
                option.value = c.name;
                option.textContent = c.name;
                dom.productCategorySelect.appendChild(option);
            });
            
            dom.productCategorySelect.value = currentVal;
        };
        
        const handleAddNewCategory = async (name) => {
            if (!name || name.trim() === "") return;
            
            const trimmedName = name.trim();
            
            if (categoriesData.some(c => c.name.toLowerCase() === trimmedName.toLowerCase())) {
                showNotif("error", "Gagal", "Kategori dengan nama tersebut sudah ada.");
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .insert([{ 
                        name: trimmedName,
                        user_id: userId
                    }])
                    .select();
                
                if (error) throw error;
                
                showNotif("success", "Berhasil", "Kategori baru telah ditambahkan.");
                return true;
            } catch (e) {
                console.error("Error adding category:", e);
                showNotif("error", "Gagal", "Terjadi kesalahan saat menambah kategori.");
                return false;
            }
        };
        
        const handleEditCategory = async (categoryId, oldName) => {
            const newName = prompt("Masukkan nama kategori baru:", oldName);
            
            if (newName && newName.trim() !== "" && newName.trim() !== oldName) {
                const trimmedNewName = newName.trim();
                
                showConfirm("Ubah Kategori?", `Mengubah nama kategori akan memperbarui semua produk terkait. Lanjutkan?`, async () => {
                    try {
                        // Update category name
                        const { error: catError } = await supabase
                            .from('categories')
                            .update({ name: trimmedNewName })
                            .eq('id', categoryId);
                        
                        if (catError) throw catError;
                        
                        // Update all products with this category
                        const { error: prodError } = await supabase
                            .from('products')
                            .update({ category_name: trimmedNewName })
                            .eq('category_name', oldName)
                            .eq('user_id', userId);
                        
                        if (prodError) throw prodError;
                        
                        showNotif("success", "Berhasil", "Kategori dan produk terkait telah diperbarui.");
                    } catch (e) {
                        showNotif("error", "Gagal", "Gagal memperbarui kategori.");
                        console.error(e);
                    }
                    
                    hideConfirm();
                });
            }
        };
        
        const handleDeleteCategory = async (categoryId, categoryName) => {
            showConfirm("Hapus Kategori?", `Produk dalam kategori '${categoryName}' tidak akan dihapus, tetapi kategorinya akan dihilangkan. Lanjutkan?`, async () => {
                try {
                    // Delete the category
                    const { error: catError } = await supabase
                        .from('categories')
                        .delete()
                        .eq('id', categoryId);
                    
                    if (catError) throw catError;
                    
                    // Remove category from all products that had it
                    const { error: prodError } = await supabase
                        .from('products')
                        .update({ category_name: null })
                        .eq('category_name', categoryName)
                        .eq('user_id', userId);
                    
                    if (prodError) throw prodError;
                    
                    showNotif("success", "Berhasil", "Kategori telah dihapus.");
                } catch (e) {
                    showNotif("error", "Gagal", "Gagal menghapus kategori.");
                    console.error(e);
                }
                
                hideConfirm();
            });
        };

        // --- RENDER FUNCTIONS ---
        const refreshUI = () => {
            if (!isAuthReady) return;
            
            if (isOpnameMode) {
                renderProductTable(true);
            } else {
                renderProductTable(false);
            }
            
            runAllReports();
            updateSettingsUI(storeSettings);
        };
        
        const renderProductSearchDropdown = (prods) => {
            dom.searchDropdown.innerHTML = "";
            
            if (prods.length === 0) {
                dom.searchDropdown.innerHTML = `<div class="p-3 text-center text-gray-500">Produk tidak ditemukan.</div>`;
                return;
            }
            
            prods.forEach(p => {
                const out = p.stock <= 0;
                const item = document.createElement("div");
                item.className = `flex items-center justify-between p-3 border-b hover:bg-gray-100 cursor-pointer ${out ? 'opacity-50 pointer-events-none' : ''}`;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${p.image}" alt="${p.name}" class="w-10 h-10 rounded-md object-cover">
                        <div>
                            <div class="font-bold">${p.name}</div>
                            <div class="text-sm text-indigo-600">${formatRupiah(p.price)}</div>
                        </div>
                    </div>
                    ${out ? '<span class="text-xs text-red-500 font-semibold">Habis</span>' : `<div class="text-sm text-gray-500">Stok: ${p.stock}</div>`}
                `;
                
                if (!out) {
                    item.onclick = () => {
                        addToCart(p.id);
                        dom.searchInput.value = '';
                        dom.searchDropdown.classList.add('hidden');
                    };
                }
                
                dom.searchDropdown.appendChild(item);
            });
        };
        
        const renderProductTable = (isOpname) => {
            dom.allProductsTable.innerHTML = "";
            const container = dom.allProductsTable;
            
            if (productsData.length === 0) {
                container.innerHTML = `<p class="text-center py-6 text-gray-500">Tidak ada produk.</p>`;
                return;
            }
            
            const table = document.createElement("table");
            table.className = "min-w-full bg-white text-sm";
            
            table.innerHTML = isOpname ? `
                <thead class="bg-yellow-100">
                    <tr>
                        <th class="py-3 px-4 text-left font-semibold text-yellow-800">Produk</th>
                        <th class="py-3 px-4 text-center font-semibold text-yellow-800">Stok Sistem</th>
                        <th class="py-3 px-4 text-center font-semibold text-yellow-800">Stok Fisik</th>
                        <th class="py-3 px-4 text-center font-semibold text-yellow-800">Selisih</th>
                    </tr>
                </thead>
            ` : `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-4 text-left font-semibold text-gray-600">Produk</th>
                        <th class="py-3 px-4 text-left font-semibold text-gray-600">Kategori</th>
                        <th class="py-3 px-4 text-left font-semibold text-gray-600">Stok</th>
                        <th class="py-3 px-4 text-center font-semibold text-gray-600">Aksi</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement("tbody");
            
            productsData.forEach(p => {
                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-200";
                
                if (isOpname) {
                    tr.innerHTML = `
                        <td class="py-2 px-4 font-bold">${p.name}</td>
                        <td class="py-2 px-4 text-center font-mono">${p.stock}</td>
                        <td class="py-2 px-4 text-center">
                            <input type="number" data-id="${p.id}" data-sistem-stock="${p.stock}" class="opname-input physical-stock-input" value="${p.stock}">
                        </td>
                        <td class="py-2 px-4 text-center selisih-display" id="selisih-${p.id}">0</td>
                    `;
                } else {
                    const isConsignment = p.product_type === 'consignment';
                    
                    tr.innerHTML = `
                        <td class="py-3 px-4 flex items-center gap-3">
                            <img src="${p.image || "https://placehold.co/100x100?text=N/A"}" class="h-12 w-12 object-cover rounded-md">
                            <div>
                                <span class="font-bold">${p.name}</span>
                                ${isConsignment ? '<span class="text-xs bg-blue-100 text-blue-800 font-semibold px-2 py-0.5 rounded-full">Titipan</span>' : ''}
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="bg-gray-200 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-full">${p.category_name || 'N/A'}</span>
                        </td>
                        <td class="py-3 px-4 font-bold text-lg ${p.stock <= LOW_STOCK_THRESHOLD ? "text-red-500" : ""}">${p.stock}</td>
                        <td class="py-3 px-4 text-center whitespace-nowrap">
                            ${isConsignment ? `<button data-id="${p.id}" class="return-btn text-orange-500 p-2 hover:bg-orange-100 rounded-full" title="Retur ke Pemasok"><i class="fas fa-truck-loading fa-fw"></i></button>` : ''}
                            <button data-id="${p.id}" class="restock-btn text-green-500 p-2 hover:bg-green-100 rounded-full" title="Restok"><i class="fas fa-plus-circle fa-fw"></i></button>
                            <button data-id="${p.id}" class="edit-btn text-blue-500 p-2 hover:bg-blue-100 rounded-full" title="Ubah"><i class="fas fa-edit fa-fw"></i></button>
                            <button data-id="${p.id}" class="delete-btn text-red-500 p-2 hover:bg-red-100 rounded-full" title="Hapus"><i class="fas fa-trash-alt fa-fw"></i></button>
                        </td>
                    `;
                }
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        };
        
        const renderCategoryManagementTable = () => {
            const container = dom.categoryTableContainer;
            container.innerHTML = "";
            
            if (categoriesData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada kategori.</p>`;
                return;
            }
            
            const table = document.createElement('table');
            table.className = "min-w-full bg-white text-sm";
            
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-4 text-left font-semibold text-gray-600">Nama Kategori</th>
                        <th class="py-3 px-4 text-center font-semibold text-gray-600">Aksi</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement('tbody');
            
            categoriesData.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const tr = document.createElement('tr');
                tr.className = "border-b";
                tr.innerHTML = `
                    <td class="py-3 px-4 font-bold">${c.name}</td>
                    <td class="py-3 px-4 text-center">
                        <button data-id="${c.id}" data-name="${c.name}" class="edit-category-btn text-blue-500 hover:text-blue-700 p-2" title="Ubah"><i class="fas fa-edit"></i></button>
                        <button data-id="${c.id}" data-name="${c.name}" class="delete-category-btn text-red-500 hover:text-red-700 p-2" title="Hapus"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
        };
        
        const renderCart = () => {
            if (cart.length === 0) {
                dom.cartItems.innerHTML = "";
                dom.cartPlaceholder.classList.remove("hidden");
            } else {
                dom.cartPlaceholder.classList.add("hidden");
                dom.cartItems.innerHTML = "";
                
                cart.forEach(i => {
                    const e = document.createElement("div");
                    e.className = "flex justify-between items-center py-3 border-b";
                    e.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold truncate">${i.name}</p>
                            <p class="text-xs text-gray-500">${i.quantity} x ${formatRupiah(i.price)}</p>
                        </div>
                        <div class="font-semibold mx-3">${formatRupiah(i.price * i.quantity)}</div>
                        <div class="flex items-center gap-2">
                            <button class="text-green-500 hover:text-green-700" onclick="app.increaseCartQty('${i.id}')">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="app.removeFromCart('${i.id}')">
                                <i class="fas fa-minus-circle"></i>
                            </button>
                        </div>
                    `;
                    
                    dom.cartItems.appendChild(e);
                });
            }
            
            updateTotal();
        };
        
        const updateTotal = () => {
            const t = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            dom.totalPrice.textContent = formatRupiah(t);
            calculateChange();
        };
        
        const calculateChange = () => {
            const t = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            const p = parseFloat(dom.paymentAmount.value) || 0;
            const c = p - t;
            dom.changeAmount.textContent = (p > 0 && c >= 0) ? formatRupiah(c) : "Rp 0";
        };
        
        const runAllReports = () => {
            let start, end = new Date();
            end.setHours(23, 59, 59, 999);
            
            switch (dom.dateFilter.value) {
                case "today":
                    start = new Date();
                    start.setHours(0, 0, 0, 0);
                    break;
                case "last7days":
                    start = new Date();
                    start.setDate(start.getDate() - 6);
                    start.setHours(0, 0, 0, 0);
                    break;
                case "thismonth":
                    start = new Date(end.getFullYear(), end.getMonth(), 1);
                    break;
                case "custom":
                    start = new Date(dom.startDate.value || start);
                    end = new Date(dom.endDate.value || end);
                    end.setHours(23, 59, 59, 999);
                    break;
            }
            
            const filteredTrans = transactionsData.filter(t => {
                const transDate = new Date(t.created_at);
                return transDate >= start && transDate <= end;
            });
            
            let totalOmzet = 0, totalTransaksi = filteredTrans.length, totalProfit = 0, totalDebt = 0;
            
            filteredTrans.forEach(t => {
                totalOmzet += t.total_amount;
                
                t.items.forEach(item => {
                    const productDetails = productsData.find(p => p.id === item.id);
                    
                    if (productDetails) {
                        if (productDetails.product_type === 'consignment') {
                            totalProfit += (item.price - (productDetails.harga_setor || 0)) * item.quantity;
                            totalDebt += (productDetails.harga_setor || 0) * item.quantity;
                        } else {
                            totalProfit += item.price * item.quantity;
                        }
                    }
                });
            });
            
            const lowStockCount = productsData.filter(p => p.stock > 0 && p.stock <= LOW_STOCK_THRESHOLD).length;
            
            dom.reportOmzet.textContent = formatRupiah(totalOmzet);
            dom.reportTransaksi.textContent = totalTransaksi;
            dom.reportLowStockCount.textContent = lowStockCount;
            dom.analysisProfit.textContent = formatRupiah(totalProfit);
            dom.analysisDebt.textContent = formatRupiah(totalDebt);
            
            dom.reportTable.innerHTML = "";
            
            if (filteredTrans.length === 0) {
                dom.reportTable.innerHTML = '<p class="text-center py-6 text-gray-500">Tidak ada transaksi.</p>';
                return;
            }
            
            const table = document.createElement("table");
            table.className = "min-w-full bg-white text-sm";
            
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left font-semibold text-gray-600">Tanggal</th>
                        <th class="p-3 text-left font-semibold text-gray-600">Item</th>
                        <th class="p-3 text-right font-semibold text-gray-600">Total</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement("tbody");
            
            filteredTrans.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(t => {
                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-200";
                tr.innerHTML = `
                    <td class="p-3 align-top">${formatDate(t.created_at)}</td>
                    <td class="p-3">${t.items.map(i => `${i.quantity}x ${i.name}`).join("<br>")}</td>
                    <td class="p-3 text-right align-top font-bold">${formatRupiah(t.total_amount)}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            dom.reportTable.appendChild(table);
        };

        // --- CORE LOGIC ---
        const addToCart = (id) => {
            const p = productsData.find(prod => prod.id === id);
            if (!p) return;
            
            const cartItem = cart.find(i => i.id === id);
            const qtyInCart = cartItem ? cartItem.quantity : 0;
            
            if (qtyInCart + 1 > p.stock) {
                showNotif("error", "Stok Tidak Cukup", `Stok ${p.name} hanya tersisa ${p.stock}.`);
                return;
            }
            
            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({
                    id: p.id,
                    name: p.name,
                    price: p.price,
                    quantity: 1
                });
            }
            
            renderCart();
        };
        
        const increaseCartQty = (id) => addToCart(id);
        
        const removeFromCart = (id) => {
            const idx = cart.findIndex(i => i.id === id);
            
            if (idx > -1) {
                if (cart[idx].quantity > 1) {
                    cart[idx].quantity--;
                } else {
                    cart.splice(idx, 1);
                }
            }
            
            renderCart();
        };
        
        const resetTransaction = () => {
            cart = [];
            dom.paymentAmount.value = "";
            renderCart();
        };
        
        const processPayment = async () => {
            if (cart.length === 0) return showNotif("warning", "Keranjang Kosong", "Tidak ada produk.");
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            const payment = parseFloat(dom.paymentAmount.value) || 0;
            
            if (payment < total) return showNotif("error", "Pembayaran Kurang", "Uang tidak cukup.");
            
            dom.paymentButton.disabled = true;
            dom.paymentButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            
            try {
                const cartToProcess = [...cart];
                
                // Start transaction
                const transactionData = {
                    user_id: userId,
                    items: cartToProcess.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    total_amount: total,
                    payment_amount: payment,
                    change_amount: payment - total,
                    created_at: new Date().toISOString()
                };
                
                // Update stock and create transaction in a single batch
                const { data: transaction, error: transactionError } = await supabase
                    .from('transactions')
                    .insert([transactionData])
                    .select()
                    .single();
                
                if (transactionError) throw transactionError;
                
                // Update product stocks
                const updates = cartToProcess.map(item => ({
                    id: item.id,
                    stock: -item.quantity
                }));
                
                const { error: updateError } = await supabase.rpc('update_product_stocks', {
                    updates: updates,
                    user_id: userId
                });
                
                if (updateError) throw updateError;
                
                showReceipt({
                    items: cartToProcess,
                    totalAmount: total,
                    paymentAmount: payment,
                    changeAmount: payment - total,
                    createdAt: new Date(),
                    id: transaction.id
                });
                
                resetTransaction();
            } catch (e) {
                console.error(e);
                showNotif("error", "Transaksi Gagal", e.message);
            } finally {
                dom.paymentButton.disabled = false;
                dom.paymentButton.innerHTML = `<i class="fas fa-cash-register"></i> Bayar`;
            }
        };
        
        const handleFormSubmit = async e => {
            e.preventDefault();
            
            const id = dom.productIdInput.value;
            const productType = dom.productTypeSelect.value;
            
            const data = {
                name: dom.productNameInput.value,
                price: parseFloat(dom.productPriceInput.value),
                stock: parseInt(dom.productStockInput.value),
                category_name: dom.productCategorySelect.value || null,
                barcode: dom.productBarcodeInput.value.trim() || null,
                image: dom.productImageBase64.value || "https://placehold.co/200x200?text=N/A",
                product_type: productType,
                harga_setor: productType === 'consignment' ? parseFloat(dom.hargaSetorInput.value) || 0 : 0,
                user_id: userId,
                updated_at: new Date().toISOString()
            };
            
            try {
                if (id) {
                    const { error } = await supabase
                        .from('products')
                        .update(data)
                        .eq('id', id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('products')
                        .insert([data]);
                    
                    if (error) throw error;
                }
                
                hideProductModal();
            } catch (err) {
                console.error(err);
                showNotif("error", "Gagal Menyimpan", err.message);
            }
        };
        
        const handleDelete = async (id) => {
            showConfirm("Hapus Produk?", "Produk ini akan dihapus permanen dari database.", async () => {
                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', id)
                        .eq('user_id', userId);
                    
                    if (error) throw error;
                    
                    hideConfirm();
                    showNotif("success", "Berhasil", "Produk telah dihapus.");
                } catch (err) {
                    console.error(err);
                    showNotif("error", "Gagal Hapus", err.message);
                }
            });
        };
        
        const handleRestockSubmit = async e => {
            e.preventDefault();
            
            const id = dom.restockProductId.value;
            const qty = parseInt(dom.restockQuantity.value);
            
            if (!id || !qty || qty <= 0) return;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .update({ stock: qty })
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                hideRestockModal();
                dom.restockForm.reset();
                showNotif("success", "Berhasil", `${qty} item ditambahkan.`);
            } catch (err) {
                console.error(err);
                showNotif("error", "Gagal Restok", err.message);
            }
        };
        
        const handleReturnSubmit = async e => {
            e.preventDefault();
            
            const id = dom.returnProductId.value;
            const qty = parseInt(dom.returnQuantity.value);
            const p = productsData.find(p => p.id === id);
            
            if (!id || !qty || qty <= 0 || qty > p.stock) {
                showNotif("error", "Input Tidak Valid", "Jumlah retur tidak boleh melebihi stok.");
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .update({ stock: p.stock - qty })
                    .eq('id', id);
                
                if (error) throw error;
                
                hideReturnModal();
                dom.returnForm.reset();
                showNotif("success", "Berhasil", `${qty} item diretur.`);
            } catch (err) {
                console.error(err);
                showNotif("error", "Gagal Retur", err.message);
            }
        };
        
        const handleSettingsSave = async e => {
            e.preventDefault();
            
            const settingsData = {
                name: dom.storeNameInput.value || "Nama Toko",
                address: dom.storeAddressInput.value || "Alamat Toko",
                phone: dom.storePhoneInput.value || "No. Telepon",
                logo: storeSettings.logo,
                user_id: userId
            };
            
            const logoFile = dom.storeLogoUpload.files[0];
            if (logoFile) {
                settingsData.logo = await fileToBase64(logoFile);
            }
            
            try {
                // Check if settings already exist
                const { data: existingSettings, error: fetchError } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;
                
                if (existingSettings) {
                    // Update existing settings
                    const { error: updateError } = await supabase
                        .from('settings')
                        .update(settingsData)
                        .eq('user_id', userId);
                    
                    if (updateError) throw updateError;
                } else {
                    // Insert new settings
                    const { error: insertError } = await supabase
                        .from('settings')
                        .insert([settingsData]);
                    
                    if (insertError) throw insertError;
                }
                
                showNotif("success", "Berhasil", "Pengaturan toko disimpan.");
            } catch (err) {
                console.error(err);
                showNotif("error", "Gagal", "Tidak dapat menyimpan pengaturan.");
            }
        };
        
        function showReceipt(data) {
            dom.strukInfo.innerHTML = `
                <div>No. Struk: ${data.id.substring(0, 8)}</div>
                <div>Tgl: ${formatDate(data.createdAt)}</div>
            `;
            
            dom.strukItems.innerHTML = data.items.map(i => `
                <div class="flex justify-between">
                    <div>${i.quantity} ${i.name}</div>
                    <span>${formatRupiah(i.price * i.quantity)}</span>
                </div>
            `).join("");
            
            dom.strukTotal.innerHTML = `
                <div class="flex justify-between font-bold">
                    <span>TOTAL</span>
                    <span>${formatRupiah(data.totalAmount)}</span>
                </div>
                <div class="flex justify-between">
                    <span>BAYAR</span>
                    <span>${formatRupiah(data.paymentAmount)}</span>
                </div>
                <div class="flex justify-between">
                    <span>KEMBALI</span>
                    <span>${formatRupiah(data.changeAmount)}</span>
                </div>
            `;
            
            dom.strukModal.classList.remove("hidden");
        }
        
        function hideReceipt() {
            dom.strukModal.classList.add("hidden");
        }
        
        const showProductModal = (edit = false, p = {}) => {
            dom.productForm.reset();
            populateCategorySelect();
            
            dom.productModalTitle.textContent = edit ? "Ubah Produk" : "Tambah Produk";
            dom.productIdInput.value = edit ? p.id : "";
            dom.productNameInput.value = edit ? p.name : "";
            dom.productPriceInput.value = edit ? p.price : "";
            dom.productStockInput.value = edit ? p.stock : "";
            dom.productCategorySelect.value = edit ? p.category_name || "" : "";
            dom.productBarcodeInput.value = edit ? p.barcode || "" : "";
            dom.productImageBase64.value = edit ? p.image : "https://placehold.co/200x200?text=N/A";
            dom.productTypeSelect.value = edit ? (p.product_type || 'owned') : 'owned';
            dom.hargaSetorInput.value = edit ? (p.harga_setor || 0) : 0;
            dom.hargaSetorContainer.classList.toggle('hidden', dom.productTypeSelect.value !== 'consignment');
            
            dom.productModal.classList.remove("hidden");
            dom.productModal.classList.add("flex");
        };
        
        const hideProductModal = () => {
            dom.productModal.classList.add("hidden");
            dom.productModal.classList.remove("flex");
        };
        
        const showRestockModal = (id) => {
            const p = productsData.find(prod => prod.id === id);
            if (!p) return;
            
            dom.restockProductId.value = id;
            dom.restockProductName.textContent = p.name;
            dom.restockCurrentStock.textContent = p.stock;
            
            dom.restockModal.classList.remove("hidden");
            dom.restockModal.classList.add("flex");
        };
        
        const hideRestockModal = () => {
            dom.restockModal.classList.add("hidden");
            dom.restockModal.classList.remove("flex");
        };
        
        const showReturnModal = (id) => {
            const p = productsData.find(prod => prod.id === id);
            if (!p) return;
            
            dom.returnProductId.value = id;
            dom.returnProductName.textContent = p.name;
            dom.returnCurrentStock.textContent = p.stock;
            
            dom.returnModal.classList.remove("hidden");
            dom.returnModal.classList.add("flex");
        };
        
        const hideReturnModal = () => {
            dom.returnModal.classList.add("hidden");
            dom.returnModal.classList.remove("flex");
        };
        
        // --- STOK OPNAME LOGIC ---
        const startOpname = () => {
            isOpnameMode = true;
            dom.manajemenActions.classList.add('hidden');
            dom.opnameActions.classList.remove('hidden');
            dom.opnameActions.classList.add('flex');
            renderProductTable(true);
        };
        
        const cancelOpname = () => {
            isOpnameMode = false;
            dom.manajemenActions.classList.remove('hidden');
            dom.opnameActions.classList.add('hidden');
            dom.opnameActions.classList.remove('flex');
            renderProductTable(false);
        };
        
        const finishOpname = () => {
            const inputs = document.querySelectorAll('.physical-stock-input');
            let updatesCount = 0;
            
            inputs.forEach(input => {
                if (parseInt(input.value) !== parseInt(input.dataset.sistemStock)) updatesCount++;
            });
            
            if (updatesCount === 0) return showNotif('info', 'Tidak Ada Perubahan', 'Tidak ada stok yang perlu disesuaikan.');
            
            showConfirm('Selesaikan Stok Opname?', `Anda akan menyesuaikan stok untuk ${updatesCount} produk. Aksi ini tidak dapat dibatalkan.`, async () => {
                try {
                    const updates = Array.from(inputs)
                        .filter(input => parseInt(input.value) !== parseInt(input.dataset.sistemStock))
                        .map(input => ({
                            id: input.dataset.id,
                            stock: parseInt(input.value)
                        }));
                    
                    const { error } = await supabase
                        .from('products')
                        .upsert(updates);
                    
                    if (error) throw error;
                    
                    showNotif('success', 'Berhasil', 'Stok produk telah disesuaikan.');
                } catch (e) {
                    showNotif('error', 'Gagal', 'Terjadi kesalahan saat menyesuaikan stok.');
                    console.error(e);
                } finally {
                    cancelOpname();
                    hideConfirm();
                }
            });
        };

        // --- DATA BACKUP & RESTORE ---
        const backupData = () => {
            if (!isAuthReady) return showNotif('warning', 'Tunggu Sebentar', 'Data belum siap untuk di-backup.');
            
            const allData = {
                products: productsData,
                transactions: transactionsData,
                categories: categoriesData,
                settings: [storeSettings]
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kasir_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotif('success', 'Backup Berhasil', 'Data telah diunduh.');
        };
        
        const restoreData = () => {
            showConfirm("Restore Data?", "Aksi ini akan MENGHAPUS semua data di database dan menggantinya dengan data dari file backup. Lanjutkan?", () => {
                hideConfirm();
                dom.restoreFileInput.click();
            });
        };
        
        const handleRestoreFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.products || !data.transactions || !data.categories || !data.settings) {
                        throw new Error("Format file backup tidak valid.");
                    }
                    
                    setSyncStatus('syncing', 'Menghapus data lama...');
                    
                    // Delete all existing data
                    const { error: deleteProductsError } = await supabase
                        .from('products')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (deleteProductsError) throw deleteProductsError;
                    
                    const { error: deleteTransactionsError } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (deleteTransactionsError) throw deleteTransactionsError;
                    
                    const { error: deleteCategoriesError } = await supabase
                        .from('categories')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (deleteCategoriesError) throw deleteCategoriesError;
                    
                    setSyncStatus('syncing', 'Mengunggah data baru...');
                    
                    // Insert new data
                    const { error: productsError } = await supabase
                        .from('products')
                        .insert(data.products.map(p => ({
                            ...p,
                            user_id: userId
                        })));
                    
                    if (productsError) throw productsError;
                    
                    const { error: transactionsError } = await supabase
                        .from('transactions')
                        .insert(data.transactions.map(t => ({
                            ...t,
                            user_id: userId
                        })));
                    
                    if (transactionsError) throw transactionsError;
                    
                    const { error: categoriesError } = await supabase
                        .from('categories')
                        .insert(data.categories.map(c => ({
                            ...c,
                            user_id: userId
                        })));
                    
                    if (categoriesError) throw categoriesError;
                    
                    // Update settings
                    const settings = data.settings[0] || {};
                    settings.user_id = userId;
                    
                    const { error: settingsError } = await supabase
                        .from('settings')
                        .upsert([settings]);
                    
                    if (settingsError) throw settingsError;
                    
                    showNotif('success', 'Restore Berhasil', 'Data telah dipulihkan.');
                } catch (error) {
                    console.error('Restore failed:', error);
                    setSyncStatus('offline', 'Restore Gagal');
                    showNotif('error', 'Restore Gagal', `Gagal memproses file: ${error.message}`);
                } finally {
                    dom.restoreFileInput.value = '';
                }
            };
            
            reader.readAsText(file);
        };
        
        // --- REPORT POPUPS ---
        const showReportDetails = (title, content) => {
            dom.reportDetailsTitle.textContent = title;
            dom.reportDetailsContent.innerHTML = content;
            dom.reportDetailsModal.classList.remove("hidden");
            dom.reportDetailsModal.classList.add("flex");
        };
        
        const hideReportDetails = () => {
            dom.reportDetailsModal.classList.add("hidden");
            dom.reportDetailsModal.classList.remove("flex");
        };
        
        const showLowStockReport = () => {
            const lowStockProds = productsData.filter(p => p.stock > 0 && p.stock <= LOW_STOCK_THRESHOLD);
            
            let content = '<p class="text-gray-600 mb-4">Daftar produk dengan stok kurang dari atau sama dengan ' + LOW_STOCK_THRESHOLD + '.</p>';
            
            if (lowStockProds.length === 0) {
                content += '<p class="text-center py-4">Semua stok aman!</p>';
            } else {
                content += '<table class="min-w-full bg-white text-sm"><thead><tr><th class="p-2 text-left">Produk</th><th class="p-2 text-right">Sisa Stok</th></tr></thead><tbody>';
                
                lowStockProds.sort((a, b) => a.stock - b.stock).forEach(p => {
                    content += `
                        <tr class="border-b">
                            <td class="p-2 font-semibold">${p.name}</td>
                            <td class="p-2 text-right font-bold text-red-600">${p.stock}</td>
                        </tr>
                    `;
                });
                
                content += '</tbody></table>';
            }
            
            showReportDetails("Laporan Stok Kritis", content);
        };
        
        const showBestsellerReport = () => {
            let salesCount = {};
            
            transactionsData.forEach(t => {
                t.items.forEach(i => {
                    salesCount[i.name] = (salesCount[i.name] || 0) + i.quantity;
                });
            });
            
            const sortedProducts = Object.entries(salesCount).sort((a, b) => b[1] - a[1]);
            
            let content = '<p class="text-gray-600 mb-4">Daftar produk terlaris berdasarkan jumlah penjualan.</p>';
            
            if (sortedProducts.length === 0) {
                content += '<p class="text-center py-4">Belum ada data penjualan.</p>';
            } else {
                content += '<table class="min-w-full bg-white text-sm"><thead><tr><th class="p-2 text-left">Produk</th><th class="p-2 text-right">Total Terjual</th></tr></thead><tbody>';
                
                sortedProducts.forEach(([name, count]) => {
                    content += `
                        <tr class="border-b">
                            <td class="p-2 font-semibold">${name}</td>
                            <td class="p-2 text-right font-bold text-indigo-600">${count}</td>
                        </tr>
                    `;
                });
                
                content += '</tbody></table>';
            }
            
            showReportDetails("Laporan Produk Terlaris", content);
        };

        // --- INIT & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => {
            html5QrCode = new Html5Qrcode("reader");
            
            if (!supabaseConfig.supabaseUrl || !supabaseConfig.supabaseKey) {
                setSyncStatus('offline', 'Konfigurasi Error');
                showNotif('error', 'Konfigurasi Supabase Tidak Ditemukan', 'Aplikasi tidak dapat terhubung ke database.');
                return;
            }
            
            // Initialize Supabase
            supabase = supabase.createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseKey);
            
            // Check session
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError) {
                console.error("Session error:", sessionError);
                setSyncStatus('offline', 'Auth Error');
                showNotif('error', 'Gagal Otentikasi', 'Tidak bisa membuat sesi aman.');
                return;
            }
            
            if (session) {
                userId = session.user.id;
                setupSupabaseListeners(userId);
            } else {
                // Sign in anonymously if no session exists
                const { data: { user }, error: signInError } = await supabase.auth.signInAnonymously();
                
                if (signInError) {
                    console.error("Anonymous sign in error:", signInError);
                    setSyncStatus('offline', 'Auth Error');
                    showNotif('error', 'Gagal Otentikasi', 'Tidak bisa membuat sesi aman.');
                    return;
                }
                
                userId = user.id;
                setupSupabaseListeners(userId);
            }
            
            // GENERAL
            dom.kasirTab.addEventListener("click", () => switchView("kasir"));
            dom.manajemenTab.addEventListener("click", () => switchView("manajemen"));
            dom.laporanTab.addEventListener("click", () => switchView("laporan"));
            dom.pengaturanTab.addEventListener("click", () => switchView("pengaturan"));
            
            // KASIR
            dom.searchInput.addEventListener("input", (e) => {
                const term = e.target.value.toLowerCase();
                
                if (term) {
                    const filtered = productsData.filter(p => p.name.toLowerCase().includes(term));
                    renderProductSearchDropdown(filtered);
                    dom.searchDropdown.classList.remove('hidden');
                } else {
                    dom.searchDropdown.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!dom.searchInput.parentElement.contains(e.target)) {
                    dom.searchDropdown.classList.add('hidden');
                }
            });
            
            dom.scanBarcodeKasirBtn.addEventListener("click", () => startScanner('addToCart'));
            dom.paymentAmount.addEventListener("input", calculateChange);
            dom.resetButton.addEventListener("click", resetTransaction);
            dom.paymentButton.addEventListener("click", processPayment);
            
            // MANAJEMEN & OPNAME
            dom.scanToAddBtn.addEventListener("click", () => startScanner('findOrAddProduct'));
            
            dom.manajemenView.addEventListener("click", async e => {
                if (isOpnameMode) {
                    const input = e.target.closest('.physical-stock-input');
                    
                    if (input) {
                        const sistemStock = parseInt(input.dataset.sistemStock);
                        const fisikStock = parseInt(input.value);
                        const selisih = fisikStock - sistemStock;
                        const selisihDisplay = document.getElementById(`selisih-${input.dataset.id}`);
                        
                        selisihDisplay.textContent = selisih > 0 ? `+${selisih}` : selisih;
                        selisihDisplay.className = `py-2 px-4 text-center selisih-display ${selisih > 0 ? 'selisih-plus' : selisih < 0 ? 'selisih-minus' : ''}`;
                    }
                    
                    return;
                }
                
                const edit = e.target.closest(".edit-btn"),
                      del = e.target.closest(".delete-btn"),
                      restock = e.target.closest(".restock-btn"),
                      retur = e.target.closest(".return-btn");
                
                if (edit) {
                    const product = productsData.find(p => p.id === edit.dataset.id);
                    if (product) showProductModal(true, product);
                }
                
                if (del) handleDelete(del.dataset.id);
                if (restock) showRestockModal(restock.dataset.id);
                if (retur) showReturnModal(retur.dataset.id);
            });
            
            dom.startOpnameBtn.addEventListener('click', startOpname);
            dom.cancelOpnameBtn.addEventListener('click', cancelOpname);
            dom.finishOpnameBtn.addEventListener('click', finishOpname);
            
            dom.addProductButton.addEventListener("click", () => showProductModal(false));
            
            dom.productImageUpload.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (file) dom.productImageBase64.value = await fileToBase64(file);
            });
            
            dom.productTypeSelect.addEventListener('change', (e) => {
                dom.hargaSetorContainer.classList.toggle('hidden', e.target.value !== 'consignment');
            });
            
            dom.cancelButton.addEventListener("click", hideProductModal);
            dom.productForm.addEventListener("submit", handleFormSubmit);
            
            // MODALS & REPORTS
            dom.closeScannerBtn.addEventListener("click", () => stopScanner(false));
            dom.cancelConfirmButton.addEventListener("click", hideConfirm);
            dom.confirmActionButton.addEventListener("click", () => {
                if (typeof currentActionConfirm === 'function') currentActionConfirm();
            });
            
            dom.notificationCloseButton.addEventListener("click", hideNotif);
            dom.strukCloseButton.addEventListener("click", hideReceipt);
            
            dom.strukPrintButton.addEventListener("click", () => {
                dom.printableArea.innerHTML = dom.strukModal.querySelector('.font-mono').outerHTML;
                document.body.classList.add("printing");
                window.print();
                document.body.classList.remove("printing");
            });
            
            dom.dateFilter.addEventListener("change", runAllReports);
            dom.applyDateButton.addEventListener("click", runAllReports);
            
            dom.reportTabRingkasan.addEventListener('click', () => {
                dom.reportContentRingkasan.classList.remove('hidden');
                dom.reportContentAnalisis.classList.add('hidden');
                dom.reportTabRingkasan.classList.add('active');
                dom.reportTabAnalisis.classList.remove('active');
            });
            
            dom.reportTabAnalisis.addEventListener('click', () => {
                dom.reportContentRingkasan.classList.add('hidden');
                dom.reportContentAnalisis.classList.remove('hidden');
                dom.reportTabRingkasan.classList.remove('active');
                dom.reportTabAnalisis.classList.add('active');
            });
            
            dom.lowStockReportBtn.addEventListener("click", showLowStockReport);
            dom.bestsellerReportBtn.addEventListener("click", showBestsellerReport);
            dom.reportDetailsCloseBtn.addEventListener("click", hideReportDetails);
            
            // RESTOCK & RETURN
            dom.cancelRestockButton.addEventListener("click", hideRestockModal);
            dom.restockForm.addEventListener("submit", handleRestockSubmit);
            
            dom.cancelReturnBtn.addEventListener("click", hideReturnModal);
            dom.returnForm.addEventListener("submit", handleReturnSubmit);

            // PENGATURAN & KATEGORI
            dom.settingsTabProfil.addEventListener('click', () => {
                dom.settingsContentProfil.classList.remove('hidden');
                dom.settingsContentKategori.classList.add('hidden');
                dom.settingsContentData.classList.add('hidden');
                dom.settingsTabProfil.classList.add('active');
                dom.settingsTabKategori.classList.remove('active');
                dom.settingsTabData.classList.remove('active');
            });
            
            dom.settingsTabKategori.addEventListener('click', () => {
                dom.settingsContentProfil.classList.add('hidden');
                dom.settingsContentKategori.classList.remove('hidden');
                dom.settingsContentData.classList.add('hidden');
                dom.settingsTabProfil.classList.remove('active');
                dom.settingsTabKategori.classList.add('active');
                dom.settingsTabData.classList.remove('active');
            });
            
            dom.settingsTabData.addEventListener('click', () => {
                dom.settingsContentProfil.classList.add('hidden');
                dom.settingsContentKategori.classList.add('hidden');
                dom.settingsContentData.classList.remove('hidden');
                dom.settingsTabProfil.classList.remove('active');
                dom.settingsTabKategori.classList.remove('active');
                dom.settingsTabData.classList.add('active');
            });
            
            dom.addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const success = await handleAddNewCategory(dom.newCategoryNameInput.value);
                if (success) dom.addCategoryForm.reset();
            });
            
            dom.categoryTableContainer.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-category-btn');
                if (editBtn) handleEditCategory(editBtn.dataset.id, editBtn.dataset.name);
                
                const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) handleDeleteCategory(deleteBtn.dataset.id, deleteBtn.dataset.name);
            });
            
            dom.settingsForm.addEventListener("submit", handleSettingsSave);
            dom.backupBtn.addEventListener("click", backupData);
            dom.restoreBtn.addEventListener("click", restoreData);
            dom.restoreFileInput.addEventListener("change", handleRestoreFile);
        });
        
        window.app = {
            addToCart,
            removeFromCart,
            increaseCartQty
        };
    </script>
</body>
</html>